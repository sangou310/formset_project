{% extends '_base.html' %}

{% block content %}
    <h1>Order追加</h1>

    <form action="" method="post">
        {{ formset.management_form }}
        {{ formset.non_form_errors }}

        <table class="table table-sm table-borderless" id="orderTable">
            {% for form in formset %}
                <tr>
                    {% for visible in form.visible_fields %}
                        <td>
                            <div class="fieldWrapper">
                                {% if forloop.parentloop.counter == 1 %}
                                    {{ visible.label_tag }}
                                {% endif %}
                                {{ visible }}
                                {{ visible.errors }}
                            </div>
                        </td>
                    {% endfor %}
                    <td class="text-right align-middle" id="id_form-{{ forloop.counter0 }}-zaiko"></td>
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>

        {% csrf_token %}
        <button class="btn btn-primary" type="submit">保存</button>
    </form>
{% endblock content %}

{% block extrajs %}
    <script>
        jQuery(function ($) {
            {#var totalManageElement = $("input#id_form-TOTAL_FORMS");#}
            {#var currentFormCount = parseInt(totalManageElement.val());#}
            const stocks = {};
            {% for stock in stock_list %}
                stocks[{{ stock.pk }}] = {{ stock.quantity }};
            {% endfor %}

            $("table#orderTable").on("change", "select", function () {
                const changedRow = $(this).attr("id").match(/\d+/);
                $("#id_form-" + changedRow + "-zaiko").text(stocks[$(this).val()]);
            });
        });
    </script>
{% endblock extrajs %}